# Readme
## ■概要
ゲーム内に銃や弓の改造パーツの種類を追加します。  
現状は下記パーツが追加されます。
パーツ種類は今後、更に追加予定です。  
* 銃身 -- 適正距離を増減させます。また、レベルに応じて射撃距離ペナルティを多少軽減します。    
* 属性付与 -- 銃や弓に火炎や冷気などの各種属性効果を追加します。  

このModは単品でも導入可能ですが、 
Mod「Elin_GunSmith」と一緒に使うことをより推奨しています。  
（Elin_GunSmithはこちら→ https://steamcommunity.com/sharedfiles/filedetails/?id=3407191321）  

## ■コンフィグ
コンフィグにて各パーツ種別ごとのバランス調整が可能です。  
プレイヤーミドルクリックからの「ExGunMods設定」にて各種設定に飛ぶことが出来ます。   
また、下記ファイルを直に編集することでも調整が可能です。  
(Elinインストールフォルダ)\BepInEx\config\yu-ituki.elin.ex-gun-mods.cfg 

## ■Modの消去とアンインストールコマンドについて
アイテムや属性のテーブルデータを追加するため、Mod導入後のセーブデータは 
このModをOFFにすると正常に動作しない可能性があります。  
そのため、Modに「アンインストール」機能を用意しました。   
プレイヤーミドルクリックからの「ExGunMods設定」にて、「アンインストール」を選択する事で   
ゲーム中にセーブされているこのModの全改造パーツの影響が削除され、   
自動でセーブされた後にタイトル画面に戻ります。  
戻った後にゲーム中のModビュワーからこのModをOFFにして頂き、   
一度ゲームを終了して頂ければ、  
このModを除いた状態からそのセーブデータで継続して遊ぶことが可能です。 

## ■IDについて
このModではelementテーブルの下記ID帯域を使用しています。  
4000000 ～ 4199999  
他のModにてelementテーブルのこの帯域を使用している場合、干渉するためご注意ください。  
もし干渉した場合はいずれかのModを削除頂く形になります。   
もしも有名どころのModと干渉していたり、様々なModと干渉したりしはじめたら、  
セーブデータのIDコンバーターなどを作成する可能性もあります。  
その際は下記にご連絡ください。  
https://github.com/yu-ituki/ElinMod/issues  

## ■注意点/免責 
このModは他のModや将来的なElin本体と干渉する恐れがあります。  
予期しないアクシデントに備え、導入前には必ずセーブデータのバックアップを取っておいてください。  
最悪セーブデータが破損する恐れがあります。  
このModにて発生する全ての事象について当方は責任を負いません。 

## ■ソースコードの解説
### ▼概要
下記ソースが概ね本体です。      
* NewRangedModManager -- 追加パーツの管理クラスです。IDの管理や各パーツクラスの初期化などをやってます。
    * アンインストール処理もここで書いてます。
* NewRangedModBase -- 追加パーツ群の基底クラスです。
* NewRangedMod_Barrel -- パーツ「銃身」のクラスです。必要な定義、および実装に必要なHarmonyPatchが置いてあります。
* NewRangedMod_Elements -- パーツ「属性付与」のクラスです。必要な定義、および実装に必要なHarmonyPatchが置いてあります。
  * 処理自体は大元のCard.DamageHP() をバイパスし、大元の属性IDに流しているだけです。

ElementsというElinの属性？テーブルを追加することで実現しています。    
ここにtag「modRanged」でデータを追加することで、改造パーツを追加することができます。  

### ▼パーツ「銃身」
aliasで装着判別をして、最適距離のgetプロパティをフックしてパーツごとの加減算距離を計算しているだけです。   

### ▼パーツ「属性付与」
多少特殊で、元の属性攻撃処理がいろいろな場所でaliasやidなどをガリガリハードコードしやがっているので、   
ギリギリまで処理変更を粘ってCard.DamageHP() のeleをバイパスするだけで対処してます。   
（本体処理ではエフェクトや状態異常計算なども全部直ID参照でやられてるので、この道しかない）  
あとの処理は全部、元の属性攻撃を背乗りさせてもらってます。    
そのため本体の処理が変更されたら多分すぐ壊れます。  

### ▼アンインストール処理
アイテムなどを追加する系なので、アイテムが追加されたあとでModをOFFにすると  
IDが存在しないっつってエラーが発生します。  
それでセーブデータがぶっ壊れる可能性があります。    
でも数千時間遊んだセーブデータ壊れるの嫌じゃないですか。    
なのでアンインストール的な処理を作りました。    
処理内容としては    
* ゲーム中の全cardが保持されてるリストがあるので、そいつを検索
* 中のthings(cardが保持している物体)を全部漁る
  * 特定のID帯域のthingは全部削除
  * 特定のID帯域のエンチャントが付与されてたら全部外す
* 同様の処理を全保存済みマップ（zone/map）にも行う
この状態でModをOFFにすれば、とりあえず理屈上はクリーンな環境に戻ります。    
ただ一つ問題があって、ElementテーブルのマスターIDが数値なので、どんなに変なIDにしても他Modと被る可能性があります。    
で、被ると、上記のアンインストール処理で、その被った別Modのエンチャントもふっとばしちゃうんですよね。  
これもう多分避けようが無くて、他Modと被ったらElinの仕組み上IDでデータ上書きされるんで、被った時点で詰みます。    
なので他Modと被らないことを祈るしかないです。   
aliasで置き換えとか検索とかコンバータとか色々考えたんすけど、Modごとのsource帯域みたいなものを本体側がサポートしてくれない限りは多分無理です。   

